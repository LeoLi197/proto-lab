<!-- Path: frontend/features/boilerplate-openai/index.html -->
<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <title>OpenAI 功能开发样板 - flashmvp</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="../../style.css">
    <link rel="icon" href="../../public/favicon.ico">
</head>
<body>
    <div class="feature-container">
        <header>
            <h1>OpenAI 功能开发样板</h1>
            <p>此页面展示了如何通过 API 网关调用 OpenAI 服务。它证明了框架的多供应商支持能力，并可作为新功能开发的起点。</p>
        </header>

        <main>
            <!-- 输入区 -->
            <section class="panel">
                <h2>试一试</h2>
                <p>请输入一句话，我们将通过后端 API 网关请求 OpenAI，并返回结果。</p>

                <div class="form-row">
                    <label for="userInput">你的输入：</label>
                    <textarea id="userInput" rows="4" placeholder="例如：请解释一下“最小可行产品”的含义"></textarea>
                </div>

                <div class="form-actions">
                    <button id="submitBtn" onclick="handleSubmit()">调用AI</button>
                </div>
            </section>
            
            <!-- 结果区 -->
            <div id="result" class="result-box" style="display: none;">
                <!-- AI 响应将在此处显示 -->
            </div>
        </main>
        
        <footer>
            <a href="../../dashboard.html">← 返回功能中心</a>
        </footer>
    </div>
    
    <!-- 引入平台必需的全局脚本 -->
    <script src="../../config.js"></script>
    <script src="../../auth.js"></script>
    <script src="../../models.js"></script>
    <script src="../../usage.js"></script>
    
    <!-- 功能专属的交互逻辑 -->
    <script>
        // ==============================================================================
        // flashmvp 功能开发核心流程 (OpenAI 范例)
        // 遵循《flashmvp 功能模块开发指南》
        // ==============================================================================

        // 步骤 1: 【必需】认证检查 (与所有功能模块相同)
        checkAuth();
        
        // --- 主要业务逻辑 ---
        async function handleSubmit() {
            const userInput = document.getElementById('userInput').value.trim();
            if (!userInput) {
                alert('请输入内容后再提交。');
                return;
            }
            
            const submitBtn = document.getElementById('submitBtn');
            const resultDiv = document.getElementById('result');
            
            // UI状态管理：进入加载状态 (与 Gemini 样板相同)
            submitBtn.disabled = true;
            submitBtn.textContent = '处理中...';
            resultDiv.style.display = 'block';
            resultDiv.innerHTML = 'AI正在思考，请稍候...';
            
            try {
                // 步骤 2: 统计用量（可选）
                if (window.usageTracker) {
                    usageTracker.track({
                        feature: 'boilerplate-openai',
                        action: 'request',
                        tokens: 0
                    });
                }

                // 步骤 3: 通过后端 API 网关调用 OpenAI
                const resp = await fetch('/api/ai-proxy', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        provider: 'openai',
                        model: MODELS.openai.defaultModel,
                        input: userInput
                    })
                });

                if (!resp.ok) {
                    const text = await resp.text().catch(() => '');
                    throw new Error(`后端返回错误状态码 ${resp.status}: ${text}`);
                }

                const data = await resp.json();

                // （可选）统计用量
                if (window.usageTracker && data && data.usage) {
                    usageTracker.track({
                        feature: 'boilerplate-openai',
                        action: 'response',
                        tokens: data.usage.total_tokens || 0,
                        cost: calculateCost('openai', data.usage)
                    });
                }

                // 显示结果
                resultDiv.innerText = data.response;
                
            } catch (error) {
                console.error('API 调用失败:', error);
                resultDiv.innerHTML = `<strong style="color:red;">处理失败：</strong> ${error.message}`;
            } finally {
                // UI状态管理：恢复初始状态 (与 Gemini 样板相同)
                submitBtn.disabled = false;
                submitBtn.textContent = '调用AI';
            }
        }
    </script>
</body>
</html>
